#!/bin/bash

# Shellscript support function file for 'make' package Make targets

# Update the .make submodule.
function updateMake() {
	(cd .make && git checkout master)
	(cd .make && git fetch)
	git submodule update --remote --merge
}

# Update the .make submodule and create a git commit for the change.
# First checks:
# - If there are no (other) outstanding changes to the repository.
# - If the branch name starts with a JIRA id, which is used for the commit message.
function updateMakeAndCommit() {
  if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
    echo "update-make-and-commit: There are outstanding changes, skipping."
  elif [ $(git branch --show-current | tr -dc - | wc -c) -lt 2 ]; then
    echo "update-make-and-commit: Unsupported branch name."
    echo "update-make-and-commit: Branch name should look like xxx-123-description where xxx-123 is the lowercase JIRA id."
    echo "update-make-and-commit: Skipping."
  else
    updateMake
    if [ -z "$(git status --porcelain 2>/dev/null)" ]; then
      echo "update-make-and-commit: .make was already up to date. Skipping commit."
    else
      JIRA_ID=$(git branch --show-current | cut -d- -f-2 | tr [:lower:] [:upper:])
      git add .make
      git commit -n -m "${JIRA_ID}: Bump .make submodule"
      echo "update-make-and-commit: Updated .make submodule and committed changes."
    fi
  fi
}
